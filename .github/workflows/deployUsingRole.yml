name: Deploy to AWS S3 and Invalidate CloudFront

on:
  push:
    branches:
      - main # Adjust to your deployment branch

permissions:
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::390403889342:role/Github-action-deploy # Replace with your role ARN
          role-session-name: github-actions-session
          aws-region: us-east-1 # Replace with your AWS region (e.g., us-east-1)

      - name: Upload file to S3
        run: |
          echo "Uploading script.js to S3:"
          aws s3 cp ./script.js s3://${{ secrets.S3_BUCKET_NAME }}/script.js

      - name: Invalidate CloudFront cache
        run: |
          echo "Invalidating script.js in CloudFront"
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/script.js"
